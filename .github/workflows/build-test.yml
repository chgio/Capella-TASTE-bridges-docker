name: Build & Test Docker Image

on:
  # runs autonomously upon regular push
  push:
    tags-ignore:
      - '*'
  # can be invoked by publish job
  workflow_call:
  # can be triggered manually
  workflow_dispatch:

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      # set up build tools
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      # build image with local caching
      - name: Build image
        uses: docker/build-push-action@v6
        with:
          tags: chgio/python4capella-docker:latest
          load: true
          cache-to: type=local,dest=/tmp/docker-cache
      # run image test script in container, relaying exit code
      # (test fails => step fails => job fails)
      - name: Test image
        run: |
          docker run --name testcontainer chgio/python4capella-docker:latest /tmp/workspace/run-test.sh
          docker inspect testcontainer --format='{{.State.ExitCode}}'
          exit $?
      # upload Docker build cache for publish job
      - name: Upload cache as artifact
        if: ${{ github.ref_type == 'tag' }}
        uses: actions/upload-artifact@v4
        with:
          name: Docker Cache
          path: /tmp/docker-cache
